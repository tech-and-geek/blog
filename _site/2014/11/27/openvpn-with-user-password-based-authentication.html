<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Openvpn With User Password Based Authentication</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Oregano&display=swap" rel="stylesheet" />

    <!-- Main CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
  </head>

  <body class="layout--single">
    <!-- Header -->
    <header class="site-header">
      <div class="container">
        <h1><a href="/">Shivam's Tech Blog</a></h1>
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="/about/">About</a>
          <a href="/categories/">Categories</a>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main class="page">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="http://localhost:4000/" itemprop="url">Shivam Shukla</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <table>
  <tbody>
    <tr>
      <td>Engineer</td>
      <td>Monitoring &amp; Automation</td>
      <td>14+ years</td>
    </tr>
  </tbody>
</table>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Openvpn With User Password Based Authentication">
    <meta itemprop="description" content="System details:-">
    <meta itemprop="datePublished" content="2014-11-27T00:00:00+05:30">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="http://localhost:4000/2014/11/27/openvpn-with-user-password-based-authentication.html" itemprop="url">Openvpn With User Password Based Authentication
</a>
          </h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>System details:-</p>

<p>OpenVPN Server IP: 192.168.1.2 (Public IP, the written IP is private used for example purpose)</p>

<p>MySQL Server IP: 192.168.1.2 (Public IP, the written IP is private used for example purpose)</p>

<p>Shell script (Customize)- 1 user - many connections</p>

<p>Install MySQL Server for User/Pass Authentication, IP = 192.168.1.2</p>

<p>Install MySQL Server</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# yum <span class="nb">install </span>mysql-server
</code></pre></div></div>

<p>Log in MySQL as root</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]#mysql <span class="nt">-uroot</span> <span class="nt">-p</span>
</code></pre></div></div>

<p>Create the database ‘openvpn’</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; CREATE DATABASE openvpn<span class="p">;</span>
</code></pre></div></div>

<p>Create a MySQL user with username ‘USERNAME’ and password ‘PASSWORD’</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt;GRANT ALL ON openvpn.<span class="k">*</span> TO <span class="s1">'USERNAME'</span>@<span class="s2">"%"</span> IDENTIFIED BY <span class="s1">'PASSWORD'</span><span class="p">;</span>
</code></pre></div></div>

<p>Log out root user</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt;exit
</code></pre></div></div>

<p>Log in MySQL as new user ’USERNAME’</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# mysql <span class="nt">-uUSERNAME</span> <span class="nt">-pPASSWORD</span>
</code></pre></div></div>

<p>Switch database</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt;USE openvpn<span class="p">;</span>
</code></pre></div></div>

<p>Create the user, log table and insert user data into it.
User table creation</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
CREATE TABLE IF NOT EXISTS <span class="sb">`</span>user<span class="sb">`</span> <span class="o">(</span>
    <span class="sb">`</span>user_id<span class="sb">`</span> varchar<span class="o">(</span>32<span class="o">)</span> COLLATE utf8_unicode_ci NOT NULL,
    <span class="sb">`</span>user_pass<span class="sb">`</span> varchar<span class="o">(</span>32<span class="o">)</span> COLLATE utf8_unicode_ci NOT NULL DEFAULT <span class="s1">'1234'</span>,
    <span class="sb">`</span>user_mail<span class="sb">`</span> varchar<span class="o">(</span>64<span class="o">)</span> COLLATE utf8_unicode_ci DEFAULT NULL,
    <span class="sb">`</span>user_phone<span class="sb">`</span> varchar<span class="o">(</span>16<span class="o">)</span> COLLATE utf8_unicode_ci DEFAULT NULL,
    <span class="sb">`</span>user_online<span class="sb">`</span> tinyint<span class="o">(</span>1<span class="o">)</span> NOT NULL DEFAULT <span class="s1">'0'</span>,
    <span class="sb">`</span>user_enable<span class="sb">`</span> tinyint<span class="o">(</span>1<span class="o">)</span> NOT NULL DEFAULT <span class="s1">'1'</span>,
    <span class="sb">`</span>user_start_date<span class="sb">`</span> <span class="nb">date </span>NOT NULL,
    <span class="sb">`</span>user_end_date<span class="sb">`</span> <span class="nb">date </span>NOT NULL,
PRIMARY KEY <span class="o">(</span><span class="sb">`</span>user_id<span class="sb">`</span><span class="o">)</span>,
KEY <span class="sb">`</span>user_pass<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>user_pass<span class="sb">`</span><span class="o">)</span>
<span class="o">)</span> <span class="nv">ENGINE</span><span class="o">=</span>MyISAM DEFAULT <span class="nv">CHARSET</span><span class="o">=</span>utf8 <span class="nv">COLLATE</span><span class="o">=</span>utf8_unicode_ci<span class="p">;</span>
</code></pre></div></div>

<p>Log table creation</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
CREATE TABLE IF NOT EXISTS <span class="sb">`</span>log<span class="sb">`</span> <span class="o">(</span>
    <span class="sb">`</span>log_id<span class="sb">`</span> int<span class="o">(</span>10<span class="o">)</span> unsigned NOT NULL AUTO_INCREMENT,
    <span class="sb">`</span>user_id<span class="sb">`</span> varchar<span class="o">(</span>32<span class="o">)</span> COLLATE utf8_unicode_ci NOT NULL,
    <span class="sb">`</span>log_trusted_ip<span class="sb">`</span> varchar<span class="o">(</span>32<span class="o">)</span> COLLATE utf8_unicode_ci DEFAULT NULL,
    <span class="sb">`</span>log_trusted_port<span class="sb">`</span> varchar<span class="o">(</span>16<span class="o">)</span> COLLATE utf8_unicode_ci DEFAULT NULL,
    <span class="sb">`</span>log_remote_ip<span class="sb">`</span> varchar<span class="o">(</span>32<span class="o">)</span> COLLATE utf8_unicode_ci DEFAULT NULL,
    <span class="sb">`</span>log_remote_port<span class="sb">`</span> varchar<span class="o">(</span>16<span class="o">)</span> COLLATE utf8_unicode_ci DEFAULT NULL,
    <span class="sb">`</span>log_start_time<span class="sb">`</span> timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    <span class="sb">`</span>log_end_time<span class="sb">`</span> timestamp NOT NULL DEFAULT <span class="s1">'0000-00-00 00:00:00'</span>,
    <span class="sb">`</span>log_received<span class="sb">`</span> float NOT NULL DEFAULT <span class="s1">'0'</span>,
    <span class="sb">`</span>log_send<span class="sb">`</span> float NOT NULL DEFAULT <span class="s1">'0'</span>,
PRIMARY KEY <span class="o">(</span><span class="sb">`</span>log_id<span class="sb">`</span><span class="o">)</span>,
KEY <span class="sb">`</span>user_id<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>user_id<span class="sb">`</span><span class="o">)</span>
<span class="o">)</span> <span class="nv">ENGINE</span><span class="o">=</span>MyISAM  DEFAULT <span class="nv">CHARSET</span><span class="o">=</span>utf8 <span class="nv">COLLATE</span><span class="o">=</span>utf8_unicode_ci<span class="p">;</span>
</code></pre></div></div>

<p>User data insertion</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
INSERT INTO <span class="sb">`</span>user<span class="sb">`</span> <span class="o">(</span>
    <span class="sb">`</span>user_id<span class="sb">`</span>, <span class="sb">`</span>user_pass<span class="sb">`</span>, <span class="sb">`</span>user_mail<span class="sb">`</span>, <span class="sb">`</span>user_phone<span class="sb">`</span>,
    <span class="sb">`</span>user_online<span class="sb">`</span>, <span class="sb">`</span>user_enable<span class="sb">`</span>, <span class="sb">`</span>user_start_date<span class="sb">`</span>, <span class="sb">`</span>user_end_date<span class="sb">`</span>
<span class="o">)</span>
VALUES <span class="o">(</span>
    <span class="s1">'foobar'</span>, <span class="s1">'foo@123'</span>, <span class="s1">'foo.bar@foobar.com'</span>,
    <span class="s1">'+1234567890'</span>, 0, 1, <span class="s1">'2014-01-01'</span>, <span class="s1">'0000-00-00'</span>
<span class="o">)</span><span class="p">;</span><span class="sb">```</span>

Now <span class="nb">let</span><span class="s1">'s have a look at the tables &amp;; user data we just created.
Tabel view
```bash
mysql&gt;show tables;
+-------------------+
| Tables_in_openvpn |
+-------------------+
| log               |
| user              |
+-------------------+
</span></code></pre></div></div>

<p>User data view</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt;select <span class="k">*</span> from user<span class="p">;</span>
+---------+-----------+---------------------+--------------+-------------+-------------+-----------------+---------------+
| user_id | user_pass | user_mail           | user_phone   | user_online | user_enable | user_start_date | user_end_date |
+---------+-----------+---------------------+--------------+-------------+-------------+-----------------+---------------+
| foobar    | foo@123      | foo.bar@foobar.com | +1234567890 |           0 |           1 | 2014-01-01      | 0000-00-00    |
+---------+-----------+---------------------+--------------+-------------+-------------+-----------------+---------------+
</code></pre></div></div>

<p>Everything seems to be OK now let’s logout of mysql</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt;exit
</code></pre></div></div>

<p>Edit file /etc/mysql/my.cnf using your favourite editor &amp;; insert # to line</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# vi /etc/my.cnf
bind-address  <span class="o">=</span> 127.0.0.1
</code></pre></div></div>

<p>Sample</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#bind-address  = 127.0.0.1</span>
</code></pre></div></div>

<p>OpenVPN Server Side Configuration
Prerequisites
OpenVPN and it’s dependencies are not available in CentOS default repositories. So, it is required to install the“EPEL” repo. in order to install OpenVPN and its dependencies.
Lets start with the installation of EPEL repo first. Downloading &amp;; installing the rpm from the below link will enable the EPEL repo on your CentOS box.</p>
<h2 id="rhelcentos-6-32-bit">RHEL/CentOS 6 32-Bit</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">[</span>root@localhost]# wget http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm
<span class="o">[</span>root@localhost]# rpm <span class="nt">-ivh</span> epel-release-6-8.noarch.rpm
</code></pre></div></div>

<h2 id="rhelcentos-6-64-bit">RHEL/CentOS 6 64-Bit</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">[</span>root@localhost]# wget http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
<span class="o">[</span>root@localhost]# rpm <span class="nt">-ivh</span> epel-release-6-8.noarch.rpm
</code></pre></div></div>

<p>Its better to update the system using the following command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
yum update
</code></pre></div></div>

<p>Install OpenVPN Software
Install the OpenVPN software using the following command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
yum <span class="nb">install </span>openvpn easy-rsa
</code></pre></div></div>

<p>The easy-rsa scripts by default are in the /usr/share/easy-rsa/ directory. Make a directory /easy-rsa/keys inside the /etc/openvpn directory and copy those scripts to that directory as shown below:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nb">mkdir</span> <span class="nt">-p</span> /etc/openvpn/easy-rsa/keys
<span class="nb">cp</span> <span class="nt">-rf</span> /usr/share/easy-rsa/2.0/<span class="k">*</span> /etc/openvpn/easy-rsa/
</code></pre></div></div>

<p>Generate CA Certificate and CA key
Edit file /etc/openvpn/easy-rsa/2.0/vars</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">[</span>root@localhost]vi /etc/openvpn/easy-rsa/vars
</code></pre></div></div>

<p>And, change the values that matches with your country, state, city, mail id etc.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c"># Don't leave any of these fields blank.</span>
<span class="nb">export </span><span class="nv">KEY_COUNTRY</span><span class="o">=</span><span class="s2">"IN"</span>
<span class="nb">export </span><span class="nv">KEY_PROVINCE</span><span class="o">=</span><span class="s2">"Delhi"</span>
<span class="nb">export </span><span class="nv">KEY_CITY</span><span class="o">=</span><span class="s2">"New Delhi"</span>
<span class="nb">export </span><span class="nv">KEY_ORG</span><span class="o">=</span><span class="s2">"Test_Lab"</span>
<span class="nb">export </span><span class="nv">KEY_EMAIL</span><span class="o">=</span><span class="s2">"foo@foobar.com"</span>
<span class="nb">export </span><span class="nv">KEY_OU</span><span class="o">=</span><span class="s2">"server"</span>
</code></pre></div></div>

<p>Go to the openvpn/easy-rsa directory:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nb">cd</span> /etc/openvpn/easy-rsa/
</code></pre></div></div>

<p>Enter the following commands one by one to initialize the certificate authority:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nb">cp </span>openssl-1.0.0.cnf openssl.cnfsource
<span class="nb">source</span> ./vars
./clean-all
</code></pre></div></div>

<p>Then, run the following command to generate CA certificate and CA key:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
./build-ca
</code></pre></div></div>

<p>Sample output:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Generating a 2048 bit RSA private key
......................................................+++
............................................................+++
writing new private key to <span class="s1">'ca.key'</span>
<span class="nt">----</span>
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="s1">'.'</span>, the field will be left blank.
<span class="nt">-----</span>
Country Name <span class="o">(</span>2 letter code<span class="o">)</span> <span class="o">[</span>IN]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
State or Province Name <span class="o">(</span>full name<span class="o">)</span> <span class="o">[</span>DEL]:----&gt; Press Enter
Locality Name <span class="o">(</span>eg, city<span class="o">)</span> <span class="o">[</span>New Delhi]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
Organization Name <span class="o">(</span>eg, company<span class="o">)</span> <span class="o">[</span>Test_Lab]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span> <span class="o">[</span>server]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
Common Name <span class="o">(</span>eg, your name or your server<span class="s1">'s hostname) [server CA]: ----&gt; Press Enter
Name [EasyRSA]: ----&gt; Press Enter
Email Address [foo@foobar.com]: ----&gt; Press Enter


We have now generated the CA certificate and CA key. Then create certificate and key for server using the following command:


./build-key-server server
</span></code></pre></div></div>

<p>Sample output:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Generating a 2048 bit RSA private key
....................+++
.............+++
writing new private key to <span class="s1">'server.key'</span>
<span class="nt">-----</span>
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="s1">'.'</span>, the field will be left blank.
<span class="nt">-----</span>
Country Name <span class="o">(</span>2 letter code<span class="o">)</span> <span class="o">[</span>IN]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
State or Province Name <span class="o">(</span>full name<span class="o">)</span> <span class="o">[</span>DEL]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
Locality Name <span class="o">(</span>eg, city<span class="o">)</span> <span class="o">[</span>New Delhi]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
Organization Name <span class="o">(</span>eg, company<span class="o">)</span> <span class="o">[</span>Test_Lab]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span> <span class="o">[</span>server]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
Common Name <span class="o">(</span>eg, your name or your server<span class="s1">'s hostname) [server]: ----&gt; Press Enter
Name [EasyRSA]: ----&gt; Press Enter
Email Address [foo@foobar.com]: ----&gt; Press Enter
Please enter the following '</span>extra<span class="s1">' attributes
to be sent with your certificate request
A challenge password []: ----&gt; Press Enter
An optional company name []: ----&gt; Press Enter
Using configuration from /etc/openvpn/easy-rsa/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject'</span>s Distinguished Name is as follows
countryName           :PRINTABLE:<span class="s1">'IN'</span>
stateOrProvinceName   :PRINTABLE:<span class="s1">'DEL'</span>
localityName          :PRINTABLE:<span class="s1">'New Delhi'</span>
organizationName      :PRINTABLE:<span class="s1">'Test_Lab'</span>
organizationalUnitName:PRINTABLE:<span class="s1">'server'</span>
commonName            :PRINTABLE:<span class="s1">'server'</span>
name                  :PRINTABLE:<span class="s1">'EasyRSA'</span>
emailAddress          :IA5STRING:<span class="s1">'foo@foobar.com'</span>
Certificate is to be certified <span class="k">until </span>Mar 23 12:21:34 2024 GMT <span class="o">(</span>3650 days<span class="o">)</span>
Sign the certificate? <span class="o">[</span>y/n]:y <span class="nt">----</span><span class="o">&gt;</span> Type Y and Press Enter
1 out of 1 certificate requests certified, commit? <span class="o">[</span>y/n]y <span class="nt">----</span><span class="o">&gt;</span> Type Y and Press Enter
Write out database with 1 new entries
Data Base Updated
</code></pre></div></div>

<p>Create certificate and key for VPN clients using the following command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./build-key client
</code></pre></div></div>

<p>If you want to create certificate and key files for each client, you should replace the client parameter with an unique identifier.
Sample output:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Generating a 2048 bit RSA private key
.......+++
..................................................................................................+++
writing new private key to <span class="s1">'client.key'</span>
<span class="nt">-----</span>
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="s1">'.'</span>, the field will be left blank.
<span class="nt">-----</span>
Country Name <span class="o">(</span>2 letter code<span class="o">)</span> <span class="o">[</span>IN]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
State or Province Name <span class="o">(</span>full name<span class="o">)</span> <span class="o">[</span>DEL]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
Locality Name <span class="o">(</span>eg, city<span class="o">)</span> <span class="o">[</span>New Delhi]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
Organization Name <span class="o">(</span>eg, company<span class="o">)</span> <span class="o">[</span>Test_Lab]: <span class="nt">----</span><span class="o">&gt;</span> Press Enter
Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span> <span class="o">[</span>server]:----&gt; Press Enter
Common Name <span class="o">(</span>eg, your name or your server<span class="s1">'s hostname) [client]: ----&gt; Press Enter
Name [EasyRSA]: ----&gt; Press Enter
Email Address [foo@foobar.com]: ----&gt; Press Enter
Please enter the following '</span>extra<span class="s1">' attributes
to be sent with your certificate request
A challenge password []: ----&gt; Press Enter
An optional company name []: ----&gt; Press Enter
Using configuration from /etc/openvpn/easy-rsa/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject'</span>s Distinguished Name is as follows
countryName           :PRINTABLE:<span class="s1">'IN'</span>
stateOrProvinceName   :PRINTABLE:<span class="s1">'DEL'</span>
localityName          :PRINTABLE:<span class="s1">'New Delhi'</span>
organizationName      :PRINTABLE:<span class="s1">'Test_Lab'</span>
organizationalUnitName:PRINTABLE:<span class="s1">'server'</span>
commonName            :PRINTABLE:<span class="s1">'client'</span>
name                  :PRINTABLE:<span class="s1">'EasyRSA'</span>
emailAddress          :IA5STRING:<span class="s1">'foo@foobar.com'</span>
Certificate is to be certified <span class="k">until </span>Mar 23 12:23:44 2024 GMT <span class="o">(</span>3650 days<span class="o">)</span>
Sign the certificate? <span class="o">[</span>y/n]:y <span class="nt">----</span><span class="o">&gt;</span> Type Y and Press Enter
1 out of 1 certificate requests certified, commit? <span class="nt">----</span><span class="o">&gt;</span> Type Y and Press Enter
Write out database with 1 new entries
Data Base Updated
</code></pre></div></div>

<p>Generate Diffie Hellman (dh) Parameter
Enter the following command to generate DH parameter.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./build-dh
</code></pre></div></div>

<p>Sample output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Generating DH parameters, 2048 bit long safe prime, generator 2This is going to take a long <span class="nb">time

</span>The necessary keys and certificates will be generated <span class="k">in </span>the /etc/openvpn/easy-rsa/keys/ directory. Copy the following certificate and key files to the /etc/openvpn/keys directory.

ca.crt
dh2048.pem
server.crt
server.key
</code></pre></div></div>

<p>Go to the directory /etc/openvpn/easy-rsa/keys/ and enter the following command to transfer the above files to/etc/openvpn/keys directory.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# <span class="nb">mkdir</span> /etc/openvpn/keys
<span class="o">[</span>root@localhost]#cd /etc/openvpn/easy-rsa/keys/
<span class="o">[</span>root@localhost]#cp dh2048.pem ca.crt server.crt server.key /etc/openvpn/keys
</code></pre></div></div>

<p>And then, you must copy all client certificates and keys to the remote VPN clients in order to authenticate to the VPN server. In our case, we have generated certificates and keys to only one client, so we have to copy the following files to the VPN client.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
ca.crt
client.crt
client.key
</code></pre></div></div>

<p>Now let’s tuneup the setup to use user authorization parameters.
Customize shell script, IP = 192.168.1.2
Create directory for script ’/etc/openvpn/script’</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]#mkdir /etc/openvpn/script
<span class="o">[</span>root@localhost]#cd /etc/openvpn/script
</code></pre></div></div>

<p>Create file config.sh ’/etc/openvpn/script/config.sh’ </p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]vi /etc/openvpn/script/config.sh
</code></pre></div></div>

<p>Insert the below code into the config.sh file</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">##Dababase Server</span>
<span class="nv">HOST</span><span class="o">=</span><span class="s1">'192.168.1.2'</span>
<span class="c">#Default port = 3306</span>
<span class="nv">PORT</span><span class="o">=</span><span class="s1">'3306'</span>
<span class="c">#Username</span>
<span class="nv">USER</span><span class="o">=</span><span class="s1">'USERNAME'</span>
<span class="c">#Password</span>
<span class="nv">PASS</span><span class="o">=</span><span class="s1">'PASSWORD'</span>
<span class="c">#database name</span>
<span class="nv">DB</span><span class="o">=</span><span class="s1">'openvpn'</span>
</code></pre></div></div>

<p>Create file test_connect_db.sh’/etc/openvpn/script/test_connect_db.sh’</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# vi test_connect_db.sh
</code></pre></div></div>

<p>Insert the below code into the test_connect_db.sh file</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">.</span> /etc/openvpn/script/config.sh
<span class="c">##Test Authentication</span>
<span class="nv">username</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">password</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">user_id</span><span class="o">=</span><span class="si">$(</span>mysql <span class="nt">-h</span><span class="nv">$HOST</span> <span class="nt">-P</span><span class="nv">$PORT</span> <span class="nt">-u</span><span class="nv">$USER</span> <span class="nt">-p</span><span class="nv">$PASS</span> <span class="nv">$DB</span> <span class="nt">-sN</span> <span class="nt">-e</span> <span class="s2">"select user_id from user where user_id = '</span><span class="nv">$username</span><span class="s2">' AND user_pass = '</span><span class="nv">$password</span><span class="s2">' AND user_enable=1 AND user_start_date != user_end_date AND TO_DAYS(now()) &gt;= TO_DAYS(user_start_date) AND (TO_DAYS(now()) &amp;lt;= TO_DAYS(user_end_date) OR user_end_date='0000-00-00')"</span><span class="si">)</span>
<span class="c">##Check user</span>
<span class="o">[</span> <span class="s2">"</span><span class="nv">$user_id</span><span class="s2">"</span> <span class="o">!=</span> <span class="s1">''</span> <span class="o">]</span> &amp;<span class="p">;</span>&amp;<span class="p">;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$user_id</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$username</span><span class="s2">"</span> <span class="o">]</span> &amp;<span class="p">;</span>&amp;<span class="p">;</span> <span class="nb">echo</span> <span class="s2">"user : </span><span class="nv">$username</span><span class="s2">"</span> &amp;<span class="p">;</span>&amp;<span class="p">;</span> <span class="nb">echo</span> <span class="s1">'authentication ok.'</span> &amp;<span class="p">;</span>&amp;<span class="p">;</span> <span class="nb">exit </span>0 <span class="o">||</span> <span class="nb">echo</span> <span class="s1">'authentication failed.'</span><span class="p">;</span> <span class="nb">exit </span>1
</code></pre></div></div>
<p>Create file login.sh ’/etc/openvpn/script/login.sh’</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# vi /etc/openvpn/script/login.sh
</code></pre></div></div>

<p>Insert the below code into the login.sh file</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">.</span> /etc/openvpn/script/config.sh
<span class="c">##Authentication</span>
<span class="nv">user_id</span><span class="o">=</span><span class="si">$(</span>mysql <span class="nt">-h</span><span class="nv">$HOST</span> <span class="nt">-P</span><span class="nv">$PORT</span> <span class="nt">-u</span><span class="nv">$USER</span> <span class="nt">-p</span><span class="nv">$PASS</span> <span class="nv">$DB</span> <span class="nt">-sN</span> <span class="nt">-e</span> <span class="s2">"select user_id from user where user_id = '</span><span class="nv">$username</span><span class="s2">' AND user_pass = '</span><span class="nv">$password</span><span class="s2">' AND user_enable=1 AND user_start_date != user_end_date AND TO_DAYS(now()) &gt;= TO_DAYS(user_start_date) AND (TO_DAYS(now()) &amp;lt;= TO_DAYS(user_end_date) OR user_end_date='0000-00-00')"</span><span class="si">)</span>
<span class="c">##Check user</span>
<span class="o">[</span> <span class="s2">"</span><span class="nv">$user_id</span><span class="s2">"</span> <span class="o">!=</span> <span class="s1">''</span> <span class="o">]</span> &amp;<span class="p">;</span>&amp;<span class="p">;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$user_id</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$username</span><span class="s2">"</span> <span class="o">]</span> &amp;<span class="p">;</span>&amp;<span class="p">;</span> <span class="nb">echo</span> <span class="s2">"user : </span><span class="nv">$username</span><span class="s2">"</span> &amp;<span class="p">;</span>&amp;<span class="p">;</span> <span class="nb">echo</span> <span class="s1">'authentication ok.'</span> &amp;<span class="p">;</span>&amp;<span class="p">;</span> <span class="nb">exit </span>0 <span class="o">||</span> <span class="nb">echo</span> <span class="s1">'authentication failed.'</span><span class="p">;</span> <span class="nb">exit </span>1
</code></pre></div></div>

<p>Create file connect.sh ’/etc/openvpn/script/connect.sh’</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# vi /etc/openvpn/script/connect.sh<span class="sb">```</span>

Insert the below code into the file connect.sh
<span class="sb">```</span>bash
<span class="c">#!/bin/bash</span>
<span class="nb">.</span> /etc/openvpn/script/config.sh
<span class="c">##insert data connection to table log</span>
mysql <span class="nt">-h</span><span class="nv">$HOST</span> <span class="nt">-P</span><span class="nv">$PORT</span> <span class="nt">-u</span><span class="nv">$USER</span> <span class="nt">-p</span><span class="nv">$PASS</span> <span class="nv">$DB</span> <span class="nt">-e</span> <span class="s2">"INSERT INTO log (log_id,user_id,log_trusted_ip,log_trusted_port,log_remote_ip,log_remote_port,log_start_time,log_end_time,log_received,log_send) VALUES(NULL,'</span><span class="nv">$common_name</span><span class="s2">','</span><span class="nv">$trusted_ip</span><span class="s2">','</span><span class="nv">$trusted_port</span><span class="s2">','</span><span class="nv">$ifconfig_pool_remote_ip</span><span class="s2">','</span><span class="nv">$remote_port_1</span><span class="s2">',now(),'0000-00-00 00:00:00','</span><span class="nv">$bytes_received</span><span class="s2">','</span><span class="nv">$bytes_sent</span><span class="s2">')"</span>
<span class="c">##set status online to user connected</span>
mysql <span class="nt">-h</span><span class="nv">$HOST</span> <span class="nt">-P</span><span class="nv">$PORT</span> <span class="nt">-u</span><span class="nv">$USER</span> <span class="nt">-p</span><span class="nv">$PASS</span> <span class="nv">$DB</span> <span class="nt">-e</span> <span class="s2">"UPDATE user SET user_online=1 WHERE ser_id='</span><span class="nv">$common_name</span><span class="s2">'"</span>
</code></pre></div></div>

<p>Create file disconnect.sh ’/etc/openvpn/script/disconnect.sh’</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# vi /etc/openvpn/script/disconnect.sh
</code></pre></div></div>

<p>Insert the below code into the disconnect.sh file</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">.</span> /etc/openvpn/script/config.sh
<span class="c">##set status offline to user disconnected</span>
mysql <span class="nt">-h</span><span class="nv">$HOST</span> <span class="nt">-P</span><span class="nv">$PORT</span> <span class="nt">-u</span><span class="nv">$USER</span> <span class="nt">-p</span><span class="nv">$PASS</span> <span class="nv">$DB</span> <span class="nt">-e</span> <span class="s2">"UPDATE user SET user_online=0 WHERE user_id='</span><span class="nv">$common_name</span><span class="s2">'"</span>
<span class="c">##insert data disconnected to table log</span>
mysql <span class="nt">-h</span><span class="nv">$HOST</span> <span class="nt">-P</span><span class="nv">$PORT</span> <span class="nt">-u</span><span class="nv">$USER</span> <span class="nt">-p</span><span class="nv">$PASS</span> <span class="nv">$DB</span> <span class="nt">-e</span> <span class="s2">"UPDATE log SET log_end_time=now(),log_received='</span><span class="nv">$bytes_received</span><span class="s2">',log_send='</span><span class="nv">$bytes_sent</span><span class="s2">' WHERE log_trusted_ip='</span><span class="nv">$trusted_ip</span><span class="s2">' AND log_trusted_port='</span><span class="nv">$trusted_port</span><span class="s2">' AND user_id='</span><span class="nv">$common_name</span><span class="s2">' AND log_end_time='0000-00-00 00:00:00'"</span>
</code></pre></div></div>

<p>Compose OpenVPN configuration files, OpenVPN server will scan the .conf files in /etc/openvpn when it starts. For each file, it forks a daemon. In this system, we need both UDP and TCP support. I created two configuration files for two daemons in charge of UDP and TCP respectively.
Create file server-tcp-443.conf ’/etc/openvpn/server-tcp-443.conf’ for Server Port:443</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c">##protocol port</span>
port 443
proto tcp
dev tun
<span class="c">##ip server client</span>
server 10.4.0.0 255.255.255.0
<span class="c">##key</span>
ca /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/server.crt
key /etc/openvpn/keys/server.key
dh /etc/openvpn/keys/dh1024.pem
<span class="c">##option</span>
persist-key
persist-tun
keepalive 5 60
reneg-sec 432000
<span class="c">##option authen.</span>
comp-lzo
user nobody
<span class="c">#group nogroup</span>
client-to-client
username-as-common-name
client-cert-not-required
auth-user-pass-verify /etc/openvpn/script/login.sh via-env
<span class="c">##push to client</span>
max-clients 50
push <span class="s2">"persist-key"</span>
push <span class="s2">"persist-tun"</span>
push <span class="s2">"redirect-gateway def1"</span>
<span class="c">#push "explicit-exit-notify 1"</span>
<span class="c">##DNS-Server</span>
push <span class="s2">"dhcp-option DNS 8.8.8.8"</span>
push <span class="s2">"dhcp-option DNS 8.8.4.4"</span>
<span class="c">##script connect-disconnect</span>
script-security 3 system
client-connect /etc/openvpn/script/connect.sh
client-disconnect /etc/openvpn/script/disconnect.sh
<span class="c">##log-status</span>
status /etc/openvpn/log/tcp_443.log
log-append /etc/openvpn/log/openvpn.log
verb 3
</code></pre></div></div>

<p>Create file server-udp-53.conf ’/etc/openvpn/server-udp-53.conf’ for Server Port:53</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# vi /etc/openvpnserver-udp-53.conf
</code></pre></div></div>

<p>Insert the below lines to the server-udp-53.conf</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">##protocol port</span>
port 53
proto udp
dev tun
<span class="c">##ip server client</span>
server 10.5.0.0 255.255.255.0
<span class="c">##key</span>
ca /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/server.crt
key /etc/openvpn/keys/server.key
dh /etc/openvpn/keys/dh1024.pem
<span class="c">##option</span>
persist-key
persist-tun
keepalive 5 60
reneg-sec 432000
<span class="c">##option authen.</span>
comp-lzo
user nobody
<span class="c">#group nogroup</span>
client-to-client
username-as-common-name
client-cert-not-required
auth-user-pass-verify /etc/openvpn/script/login.sh via-env
<span class="c">##push to client</span>
max-clients 50
push <span class="s2">"persist-key"</span>
push <span class="s2">"persist-tun"</span>
push <span class="s2">"redirect-gateway def1"</span>
push <span class="s2">"explicit-exit-notify 1"</span>
<span class="c">##DNS-Server</span>
push <span class="s2">"dhcp-option DNS 8.8.8.8"</span>
push <span class="s2">"dhcp-option DNS 8.8.4.4"</span>
<span class="c">##script connect-disconnect</span>
script-security 3 system
client-connect /etc/openvpn/script/connect.sh
client-disconnect /etc/openvpn/script/disconnect.sh
<span class="c">##log-status</span>
status /etc/openvpn/log/udp_53.log
log-append /etc/openvpn/log/openvpn.log
verb 3
</code></pre></div></div>

<p>Create directory for log ’/etc/openvpn/log’</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# mkdir /etc/openvpn/log
<span class="o">[</span>root@localhost]# <span class="nb">touch</span> /etc/openvpn/log/openvpn.log
<span class="o">[</span>root@localhost]# <span class="nb">touch</span> /etc/openvpn/log/tcp_443.log
<span class="o">[</span>root@localhost]# <span class="nb">touch</span> /etc/openvpn/log/udp_53.log
</code></pre></div></div>

<p>Changes the permission of files</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod</span> <span class="nt">-R</span> 755 /etc/openvpn
</code></pre></div></div>

<p>Test authentication username ’foobar’ and password ’foo@123’</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# /etc/openvpn/script/test_connect_db.sh foobar foo@123
<span class="c"># user : test</span>
<span class="c"># authentication ok.</span>
<span class="c"># if authentication failed. check user and password in database</span>
<span class="c"># or detail database server in /etc/openvpn/script/config.sh</span>
</code></pre></div></div>

<p>Start serviece OpenVPN</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# /etc/init.d/openvpn start
</code></pre></div></div>

<p>Edit file /etc/sysctl.conf Remove # In line : #net.ipv4.ip_forward=1</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]#vi /etc/sysctl.conf
net.ipv4.ip_forward<span class="o">=</span>1
</code></pre></div></div>

<p>Execute the sysctl -p command for the changes to take effect</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# sysctl <span class="nt">-p</span>
</code></pre></div></div>

<p>Edit file /etc/rc.local Add before exit 0; the below code</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nb">echo</span> <span class="s2">"1"</span> <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
<span class="nb">echo</span> <span class="s2">"1"</span> <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_dynaddr
iptables <span class="nt">-A</span> INPUT <span class="nt">-i</span> tun0 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-A</span> FORWARD <span class="nt">-i</span> tun0 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-A</span> INPUT <span class="nt">-i</span> tun1 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-A</span> FORWARD <span class="nt">-i</span> tun1 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> udp <span class="nt">--dport</span> 53 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-A</span> INPUT <span class="nt">-i</span> eth0 <span class="nt">-p</span> tcp <span class="nt">-m</span> tcp <span class="nt">--dport</span> 3306 <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 10.4.0.0/24 <span class="nt">-o</span> eth0 <span class="nt">-j</span> MASQUERADE
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 10.5.0.0/24 <span class="nt">-o</span> eth0 <span class="nt">-j</span> MASQUERADE
iptables <span class="nt">-A</span> INPUT <span class="nt">-i</span> eth0 <span class="nt">-p</span> tcp <span class="nt">-m</span> tcp <span class="nt">--dport</span> 3306 <span class="nt">-j</span> ACCEPT
</code></pre></div></div>

<p>Run Script Iptables</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost]# /etc/rc.local
<span class="o">[</span>root@localhost]# iptables-save
</code></pre></div></div>

<p>Config for Client
Config for port TCP port 443</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
client
dev tun
proto tcp
remote 192.168.1.2 443
nobind
auth-user-pass
reneg-sec 432000
resolv-retry infinite
ca ca.crt
comp-lzo
verb 1
</code></pre></div></div>

<p>Config for port UDP port 53</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
client
dev tun
proto udp
remote 1.1.1.1 53
nobind
auth-user-pass
reneg-sec 432000
resolv-retry infinite
ca ca.crt
comp-lzo
verb 1
</code></pre></div></div>

<p>That’s it, all done
Test it &amp;; share your feedback.  :)</p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2014-11-27T00:00:00+05:30">November 27, 2014</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/2014/11/17/secure-your-ssh-with-two-step-authentication-using-google-authenticator.html" class="pagination--pager" title="Secure Your Ssh With Two Step Authentication Using Google Authenticator">Previous</a>
    
    
      <a href="/2015/07/19/setup-a-dns-server-on-centos-6-step-by-step.html" class="pagination--pager" title="Setup A Dns Server On Centos 6 Step By Step">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

    </main>

    <!-- Footer -->
    <footer class="site-footer">
      <p>&copy; 2025 Shivam's Tech Blog</p>
    </footer>
  </body>
</html>
